<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>T-Shirt Outline Creator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .drag-active {
            border-color: #4f46e5;
            background-color: rgba(79, 70, 229, 0.1);
        }
    </style>
</head>
<body class="bg-gray-900 text-white min-h-screen flex flex-col font-sans antialiased">

    <!-- Fixed Header -->
    <header class="bg-gray-800 border-b border-gray-700 py-4 px-4 sticky top-0 z-40">
        <div class="w-full max-w-6xl mx-auto">
            <div class="flex justify-between items-start mb-2">
                <div class="flex-1"></div>
                <h1 class="text-2xl font-bold bg-gradient-to-r from-indigo-400 to-cyan-400 text-transparent bg-clip-text text-center">
                    T-Shirt Outline Creator
                </h1>
                <div class="flex-1 flex justify-end">
                    <button id="libraryButton" class="bg-cyan-600 hover:bg-cyan-700 text-white font-semibold py-2 px-6 rounded-lg transition-colors">
                        Library
                    </button>
                </div>
            </div>
            <p class="text-gray-400 text-center text-sm">
                Upload an image to generate its line art outline. Perfect for custom T-shirt designs.
            </p>
        </div>
    </header>

    <!-- Main Content -->
    <main class="flex-1 p-4 overflow-y-auto">
        <div class="w-full max-w-6xl mx-auto">
            <!-- Image Upload Dropzone -->
            <div id="upload-container" class="mb-6">
                <div id="dropzone" class="w-full max-w-3xl mx-auto bg-gray-800 border-2 border-dashed border-gray-600 rounded-xl p-12 cursor-pointer transition-all duration-300 hover:border-cyan-500">
                    <div class="flex flex-col items-center justify-center space-y-4">
                        <svg class="w-16 h-16 text-gray-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M12 16.5V9.75m0 0l-3.75 3.75M12 9.75l3.75 3.75M3 17.25V6.75A2.25 2.25 0 015.25 4.5h13.5A2.25 2.25 0 0121 6.75v10.5A2.25 2.25 0 0118.75 19.5H5.25A2.25 2.25 0 013 17.25z" />
                        </svg>
                        <p class="text-lg font-semibold text-gray-300">Drag & drop your image here</p>
                        <p class="text-gray-500">or</p>
                        <button type="button" id="uploadButton" class="bg-cyan-600 hover:bg-cyan-700 text-white font-semibold py-3 px-6 rounded-lg transition-colors text-lg">
                            Click to upload
                        </button>
                    </div>
                    <input type="file" id="fileInput" class="hidden" accept="image/*">
                </div>
            </div>

            <!-- Model Selection and Prompt Input -->
            <div class="w-full max-w-3xl mx-auto space-y-4">
                <div>
                    <label for="modelSelect" class="block text-sm font-medium text-gray-300 mb-2">AI Model</label>
                    <select
                        id="modelSelect"
                        class="w-full bg-gray-800 border border-gray-600 rounded-lg px-4 py-3 text-white focus:outline-none focus:ring-2 focus:ring-cyan-500 focus:border-transparent"
                    >
                        <option value="flux-pro">Flux Pro (Canny)</option>
                        <option value="gemini">Gemini Nano</option>
                    </select>
                </div>
                <div>
                    <label for="promptInput" class="block text-sm font-medium text-gray-300 mb-2">Prompt</label>
                    <textarea
                        id="promptInput"
                        rows="4"
                        class="w-full bg-gray-800 border border-gray-600 rounded-lg px-4 py-3 text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-cyan-500 focus:border-transparent resize-none"
                        placeholder="Enter your prompt here..."
                    >A minimalist line art outline, black lines on a clean white background, no shading, coloring book style</textarea>
                </div>
            </div>
        
            <div id="app-container" class="hidden">
                <!-- Loading Indicator -->
                <div id="loading" class="hidden mt-4 flex flex-col items-center justify-center">
                    <svg class="animate-spin h-8 w-8 text-cyan-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <p id="loading-status" class="mt-3 text-gray-400 text-sm">Processing your image...</p>
                </div>

                <!-- Error Display -->
                <div id="error" class="hidden mt-4 w-full max-w-2xl mx-auto bg-red-900/50 border border-red-500 text-red-300 px-4 py-3 rounded-lg" role="alert">
                    <strong class="font-bold">Error:</strong>
                    <span id="error-message" class="block sm:inline">Something went wrong.</span>
                </div>

                <!-- Results Display -->
                <div id="results-grid" class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4 w-full">
                    <!-- Original Image -->
                    <div id="original-container" class="bg-gray-800 p-3 rounded-lg shadow-lg">
                        <h2 class="text-lg font-semibold mb-2 text-gray-300">Original Image</h2>
                        <div class="aspect-square bg-gray-700 rounded-lg overflow-hidden">
                            <img id="originalImage" src="" alt="Original user upload" class="w-full h-full object-contain">
                        </div>
                        <button type="button" id="createOutlineButton" class="hidden mt-3 bg-cyan-600 hover:bg-cyan-700 text-white font-semibold py-2 px-4 rounded-lg transition-colors w-full">
                            Create Outline
                        </button>
                    </div>
                    <!-- Generated Outline -->
                    <div id="outline-container" class="hidden bg-gray-800 p-3 rounded-lg shadow-lg">
                        <h2 class="text-lg font-semibold mb-2 text-gray-300">Generated Outline</h2>
                        <div class="aspect-square bg-gray-700 rounded-lg overflow-hidden">
                            <img id="outlineImage" src="" alt="AI-generated outline" class="w-full h-full object-contain">
                        </div>
                        <div class="mt-3 flex gap-2">
                            <button type="button" id="saveButton" class="flex-1 bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-3 rounded-lg transition-colors text-sm">
                                Save
                            </button>
                            <button type="button" id="downloadButton" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-3 rounded-lg transition-colors text-sm">
                                Download
                            </button>
                        </div>
                    </div>
                </div>

                <div class="text-center">
                    <button id="startOverButton" class="hidden mt-4 bg-gray-700 hover:bg-gray-600 text-white font-semibold py-2 px-6 rounded-lg transition-colors">
                        Start Over
                    </button>
                </div>
            </div>
        </div>
    </main>

        <!-- Library Modal -->
        <div id="libraryModal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4">
            <div class="bg-gray-800 rounded-xl max-w-6xl w-full max-h-[90vh] overflow-hidden flex flex-col">
                <div class="p-6 border-b border-gray-700 flex justify-between items-center">
                    <h2 class="text-2xl font-bold text-white">Saved Library</h2>
                    <button id="closeLibraryButton" class="text-gray-400 hover:text-white transition-colors">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
                <div id="libraryContent" class="p-6 overflow-y-auto flex-1">
                    <div id="libraryGrid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                    </div>
                    <div id="libraryEmpty" class="hidden text-center py-12 text-gray-400">
                        <svg class="w-16 h-16 mx-auto mb-4 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                        </svg>
                        <p class="text-lg">No saved images yet</p>
                        <p class="text-sm mt-2">Generate and save outlines to see them here</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="hidden fixed top-20 left-1/2 transform -translate-x-1/2 bg-gray-800 border border-cyan-500 text-white px-6 py-3 rounded-lg shadow-lg z-50 transition-opacity">
        <p id="toast-message" class="text-sm font-medium"></p>
    </div>

    <script type="module">
        // Use the new, recommended @fal-ai/client
        import { fal } from 'https://esm.sh/@fal-ai/client';
        import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';

        // Get API keys from environment variables
        const FAL_API_KEY = import.meta.env.VITE_FAL_API_KEY;
        const GEMINI_API_KEY = import.meta.env.VITE_GEMINI_API_KEY;
        const SUPABASE_URL = import.meta.env.VITE_SUPABASE_URL;
        const SUPABASE_ANON_KEY = import.meta.env.VITE_SUPABASE_ANON_KEY;

        // Initialize Supabase client
        const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // DOM Element References
        const modelSelect = document.getElementById('modelSelect');
        const promptInput = document.getElementById('promptInput');
        const uploadContainer = document.getElementById('upload-container');
        const dropzone = document.getElementById('dropzone');
        const fileInput = document.getElementById('fileInput');
        const uploadButton = document.getElementById('uploadButton');
        
        const appContainer = document.getElementById('app-container');
        const loading = document.getElementById('loading');
        const loadingStatus = document.getElementById('loading-status');
        const errorContainer = document.getElementById('error');
        const errorMessage = document.getElementById('error-message');
        
        const resultsGrid = document.getElementById('results-grid');
        const originalContainer = document.getElementById('original-container');
        const outlineContainer = document.getElementById('outline-container');
        const originalImage = document.getElementById('originalImage');
        const outlineImage = document.getElementById('outlineImage');
        const createOutlineButton = document.getElementById('createOutlineButton');
        const startOverButton = document.getElementById('startOverButton');
        const saveButton = document.getElementById('saveButton');
        const downloadButton = document.getElementById('downloadButton');
        const libraryButton = document.getElementById('libraryButton');
        const libraryModal = document.getElementById('libraryModal');
        const closeLibraryButton = document.getElementById('closeLibraryButton');
        const libraryGrid = document.getElementById('libraryGrid');
        const libraryEmpty = document.getElementById('libraryEmpty');
        const toast = document.getElementById('toast');
        const toastMessage = document.getElementById('toast-message');

        let isProcessing = false;
        let currentFile = null;
        let currentGeneratedImage = null;

        function showToast(message, duration = 3000) {
            toastMessage.textContent = message;
            toast.classList.remove('hidden');
            setTimeout(() => {
                toast.classList.add('hidden');
            }, duration);
        }

        // --- Event Listeners ---
        dropzone.addEventListener('click', () => fileInput.click());
        uploadButton.addEventListener('click', (e) => {
            e.stopPropagation();
            fileInput.click();
        });
        fileInput.addEventListener('change', (e) => {
            if (e.target.files && e.target.files[0]) {
                handleFile(e.target.files[0]);
            }
        });
        createOutlineButton.addEventListener('click', processImage);
        startOverButton.addEventListener('click', resetApp);
        saveButton.addEventListener('click', saveToLibrary);
        downloadButton.addEventListener('click', downloadImage);
        libraryButton.addEventListener('click', openLibrary);
        closeLibraryButton.addEventListener('click', closeLibrary);

        // --- Drag and Drop ---
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropzone.addEventListener(eventName, preventDefaults, false);
            document.body.addEventListener(eventName, preventDefaults, false);
        });
        ['dragenter', 'dragover'].forEach(eventName => {
            dropzone.addEventListener(eventName, () => dropzone.classList.add('drag-active'), false);
        });
        ['dragleave', 'drop'].forEach(eventName => {
            dropzone.addEventListener(eventName, () => dropzone.classList.remove('drag-active'), false);
        });
        dropzone.addEventListener('drop', (e) => {
            if (e.dataTransfer.files && e.dataTransfer.files[0]) {
                handleFile(e.dataTransfer.files[0]);
            }
        }, false);
        
        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }
        
        function handleFile(file) {
            if (!file.type.startsWith('image/')) {
                showToast('Invalid file type. Please upload an image.');
                return;
            }
            currentFile = file;

            const reader = new FileReader();
            reader.onload = (e) => {
                originalImage.src = e.target.result;
                uploadContainer.classList.add('hidden');
                appContainer.classList.remove('hidden');
                resultsGrid.classList.remove('hidden');
                outlineContainer.classList.add('hidden');
                createOutlineButton.classList.remove('hidden');
                startOverButton.classList.add('hidden');
                errorContainer.classList.add('hidden');
            };
            reader.onerror = () => showToast('Could not read the selected file.');
            reader.readAsDataURL(file);
        }

        async function processImage() {
            if (isProcessing) return;

            const selectedModel = modelSelect.value;
            const prompt = promptInput.value.trim();

            if (!prompt) {
                showToast('Please enter a prompt.');
                return;
            }

            // Check API key based on selected model
            if (selectedModel === 'flux-pro' && (!FAL_API_KEY || FAL_API_KEY === 'your_fal_api_key_here')) {
                showToast('Flux Pro API key not configured.');
                return;
            }

            if (selectedModel === 'gemini' && (!GEMINI_API_KEY || GEMINI_API_KEY === 'your_gemini_api_key_here')) {
                showToast('Gemini API key not configured.');
                return;
            }

            isProcessing = true;
            loading.classList.remove('hidden');
            createOutlineButton.classList.add('hidden');
            errorContainer.classList.add('hidden');

            // Save prompt to database
            await savePromptToLibrary(prompt, selectedModel);

            if (selectedModel === 'flux-pro') {
                runFluxPro(currentFile, prompt);
            } else if (selectedModel === 'gemini') {
                runGemini(currentFile, prompt);
            }
        }

        /**
         * Saves a prompt to the library in Supabase
         */
        async function savePromptToLibrary(promptText, model) {
            try {
                // Check if prompt already exists
                const { data: existing } = await supabase
                    .from('prompts')
                    .select('id, used_count')
                    .eq('prompt_text', promptText)
                    .eq('model', model)
                    .maybeSingle();

                if (existing) {
                    // Update usage count
                    await supabase
                        .from('prompts')
                        .update({ used_count: existing.used_count + 1 })
                        .eq('id', existing.id);
                } else {
                    // Insert new prompt
                    await supabase
                        .from('prompts')
                        .insert({
                            prompt_text: promptText,
                            model: model,
                            used_count: 1
                        });
                }
            } catch (error) {
                console.error('Error saving prompt:', error);
            }
        }

        /**
         * Calls the Flux Pro API to generate the image outline
         */
        async function runFluxPro(imageFile, prompt) {
            loadingStatus.textContent = 'Connecting to Flux Pro API...';

            try {
                fal.config({
                    credentials: FAL_API_KEY,
                });

                const result = await fal.subscribe("fal-ai/flux-pro/v1/canny", {
                    input: {
                        prompt: prompt,
                        control_image_url: imageFile,
                    },
                    logs: true,
                    onQueueUpdate: (update) => {
                        if (update.status === "IN_PROGRESS" && update.logs.length > 0) {
                           const lastLog = update.logs[update.logs.length - 1].message;
                           loadingStatus.textContent = lastLog;
                        }
                    },
                });

                if (result && result.data && result.data.images && result.data.images.length > 0) {
                    const imageUrl = result.data.images[0].url;
                    outlineImage.src = imageUrl;
                    currentGeneratedImage = {
                        dataUrl: imageUrl,
                        mimeType: 'image/png'
                    };
                    outlineContainer.classList.remove('hidden');
                } else {
                    throw new Error("API did not return a valid image. Check the model's output format.");
                }

            } catch (error) {
                console.error("Flux Pro API Error:", error);
                showError(error.message || 'An unknown error occurred during processing.');
            } finally {
                isProcessing = false;
                loading.classList.add('hidden');
                loadingStatus.textContent = 'Processing your image...';
                startOverButton.classList.remove('hidden');
            }
        }

        /**
         * Calls the Gemini API to generate the image outline
         */
        async function runGemini(imageFile, prompt) {
            loadingStatus.textContent = 'Connecting to Gemini API...';

            try {
                // Convert file to base64
                const base64 = await fileToBase64(imageFile);

                loadingStatus.textContent = 'Processing with Gemini...';

                // Call Gemini 2.5 Flash Image API using v1beta endpoint
                const requestBody = {
                    contents: [{
                        parts: [
                            { text: prompt },
                            {
                                inline_data: {
                                    mime_type: imageFile.type,
                                    data: base64
                                }
                            }
                        ]
                    }],
                    generation_config: {
                        response_modalities: ['IMAGE']
                    }
                };

                console.log('Sending request to Gemini:', JSON.stringify(requestBody, null, 2).substring(0, 500));

                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-image:generateContent?key=${GEMINI_API_KEY}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestBody)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    console.error('API Error Response:', errorData);
                    throw new Error(errorData.error?.message || `API request failed with status ${response.status}`);
                }

                const result = await response.json();
                console.log('API Response:', JSON.stringify(result, null, 2));

                if (result.candidates && result.candidates[0]?.content?.parts) {
                    const parts = result.candidates[0].content.parts;
                    console.log('Parts:', JSON.stringify(parts, null, 2));

                    for (const part of parts) {
                        if (part.inline_data || part.inlineData) {
                            const imageData = part.inline_data || part.inlineData;
                            const dataUrl = `data:${imageData.mime_type || imageData.mimeType};base64,${imageData.data}`;

                            outlineImage.src = dataUrl;
                            currentGeneratedImage = {
                                dataUrl: dataUrl,
                                mimeType: imageData.mime_type || imageData.mimeType || 'image/png'
                            };
                            outlineContainer.classList.remove('hidden');
                            return;
                        }
                    }

                    throw new Error("Gemini API did not return an image in the response.");
                } else {
                    throw new Error("Gemini API returned unexpected response structure.");
                }

            } catch (error) {
                console.error("Gemini API Error:", error);
                showError(error.message || 'An unknown error occurred with Gemini API.');
            } finally {
                isProcessing = false;
                loading.classList.add('hidden');
                loadingStatus.textContent = 'Processing your image...';
                startOverButton.classList.remove('hidden');
            }
        }

        /**
         * Converts a file to base64 string
         */
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => {
                    const base64 = reader.result.split(',')[1];
                    resolve(base64);
                };
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }
        
        function showError(message) {
            errorMessage.textContent = message;
            errorContainer.classList.remove('hidden');
            resultsGrid.classList.add('hidden'); // Hide results on error
            startOverButton.classList.remove('hidden');
        }

        function resetApp() {
            isProcessing = false;
            currentFile = null;
            currentGeneratedImage = null;
            fileInput.value = '';

            appContainer.classList.add('hidden');
            uploadContainer.classList.remove('hidden');
        }

        async function saveToLibrary() {
            if (!currentGeneratedImage) {
                showToast('No image to save');
                return;
            }

            try {
                const { error } = await supabase
                    .from('generated_images')
                    .insert({
                        original_filename: currentFile ? currentFile.name : 'unknown',
                        prompt_text: promptInput.value.trim(),
                        image_data: currentGeneratedImage.dataUrl,
                        mime_type: currentGeneratedImage.mimeType
                    });

                if (error) throw error;

                showToast('Image saved to library successfully!');
            } catch (error) {
                console.error('Error saving to library:', error);
                showToast('Failed to save image: ' + error.message);
            }
        }

        function downloadImage() {
            if (!currentGeneratedImage) {
                showToast('No image to download');
                return;
            }

            const link = document.createElement('a');
            link.href = currentGeneratedImage.dataUrl;
            link.download = `outline-${Date.now()}.png`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        async function openLibrary() {
            libraryModal.classList.remove('hidden');
            await loadLibrary();
        }

        function closeLibrary() {
            libraryModal.classList.add('hidden');
        }

        async function loadLibrary() {
            try {
                const { data, error } = await supabase
                    .from('generated_images')
                    .select('*')
                    .order('created_at', { ascending: false });

                if (error) throw error;

                libraryGrid.innerHTML = '';

                if (!data || data.length === 0) {
                    libraryEmpty.classList.remove('hidden');
                    return;
                }

                libraryEmpty.classList.add('hidden');

                data.forEach(image => {
                    const card = document.createElement('div');
                    card.className = 'bg-gray-700 rounded-lg overflow-hidden shadow-lg';
                    card.innerHTML = `
                        <div class="aspect-square bg-gray-800">
                            <img src="${image.image_data}" alt="Generated outline" class="w-full h-full object-contain">
                        </div>
                        <div class="p-3">
                            <p class="text-sm text-gray-300 truncate mb-2" title="${image.prompt_text}">${image.prompt_text}</p>
                            <p class="text-xs text-gray-500 mb-3">${new Date(image.created_at).toLocaleDateString()}</p>
                            <div class="flex gap-2">
                                <button onclick="downloadLibraryImage('${image.id}')" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white text-sm py-1 px-2 rounded transition-colors">
                                    Download
                                </button>
                                <button onclick="deleteLibraryImage('${image.id}')" class="flex-1 bg-red-600 hover:bg-red-700 text-white text-sm py-1 px-2 rounded transition-colors">
                                    Delete
                                </button>
                            </div>
                        </div>
                    `;
                    libraryGrid.appendChild(card);
                });
            } catch (error) {
                console.error('Error loading library:', error);
                showToast('Failed to load library: ' + error.message);
            }
        }

        window.downloadLibraryImage = async function(imageId) {
            try {
                const { data, error } = await supabase
                    .from('generated_images')
                    .select('*')
                    .eq('id', imageId)
                    .maybeSingle();

                if (error) throw error;
                if (!data) throw new Error('Image not found');

                const link = document.createElement('a');
                link.href = data.image_data;
                link.download = `outline-${data.original_filename}-${Date.now()}.png`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            } catch (error) {
                console.error('Error downloading image:', error);
                showToast('Failed to download image: ' + error.message);
            }
        };

        window.deleteLibraryImage = async function(imageId) {
            if (!confirm('Are you sure you want to delete this image?')) {
                return;
            }

            try {
                const { error } = await supabase
                    .from('generated_images')
                    .delete()
                    .eq('id', imageId);

                if (error) throw error;

                await loadLibrary();
                showToast('Image deleted successfully');
            } catch (error) {
                console.error('Error deleting image:', error);
                showToast('Failed to delete image: ' + error.message);
            }
        };
    </script>
</body>
</html>