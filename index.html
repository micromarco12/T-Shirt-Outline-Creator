<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>T-Shirt Outline Creator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* A simple style for the drag-active state on the dropzone */
        .drag-active {
            border-color: #4f46e5;
            background-color: rgba(79, 70, 229, 0.1);
        }
    </style>
</head>
<body class="bg-gray-900 text-white min-h-screen flex flex-col items-center justify-center p-4 font-sans antialiased">

    <div class="w-full max-w-4xl mx-auto text-center">
        <h1 class="text-4xl md:text-5xl font-bold bg-gradient-to-r from-indigo-400 to-cyan-400 text-transparent bg-clip-text mb-2">
            T-Shirt Outline Creator
        </h1>
        <p class="text-gray-400 mb-8 max-w-2xl mx-auto">
            Upload an image to generate its line art outline. Perfect for custom T-shirt designs.
        </p>

        <!-- Model Selection and Prompt Input -->
        <div class="mb-6 w-full max-w-2xl mx-auto space-y-4">
            <div>
                <label for="modelSelect" class="block text-sm font-medium text-gray-300 mb-2">AI Model</label>
                <select
                    id="modelSelect"
                    class="w-full bg-gray-800 border border-gray-600 rounded-lg px-4 py-2 text-white focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                >
                    <option value="flux-pro">Flux Pro (Canny)</option>
                    <option value="gemini">Gemini Nano</option>
                </select>
            </div>
            <div>
                <label for="promptInput" class="block text-sm font-medium text-gray-300 mb-2">Prompt</label>
                <textarea
                    id="promptInput"
                    rows="3"
                    class="w-full bg-gray-800 border border-gray-600 rounded-lg px-4 py-2 text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent resize-none"
                    placeholder="Enter your prompt here..."
                >A minimalist line art outline, black lines on a clean white background, no shading, coloring book style</textarea>
            </div>
        </div>

        <!-- Image Upload Dropzone -->
        <div id="upload-container">
            <div id="dropzone" class="w-full max-w-lg mx-auto bg-gray-800 border-2 border-dashed border-gray-600 rounded-xl p-8 cursor-pointer transition-all duration-300 hover:border-indigo-500">
                <div class="flex flex-col items-center justify-center space-y-4">
                    <svg class="w-12 h-12 text-gray-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 16.5V9.75m0 0l-3.75 3.75M12 9.75l3.75 3.75M3 17.25V6.75A2.25 2.25 0 015.25 4.5h13.5A2.25 2.25 0 0121 6.75v10.5A2.25 2.25 0 0118.75 19.5H5.25A2.25 2.25 0 013 17.25z" />
                    </svg>
                    <p class="text-lg font-semibold text-gray-300">Drag & drop your image here</p>
                    <p class="text-gray-500">or</p>
                    <button type="button" id="uploadButton" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg transition-colors">
                        Click to upload
                    </button>
                </div>
                <input type="file" id="fileInput" class="hidden" accept="image/*">
            </div>
        </div>
        
        <div id="app-container" class="hidden">
            <!-- Loading Indicator -->
            <div id="loading" class="hidden mt-8 flex flex-col items-center justify-center">
                <svg class="animate-spin -ml-1 mr-3 h-8 w-8 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <p id="loading-status" class="mt-4 text-gray-400">Processing your image...</p>
            </div>
            
            <!-- Error Display -->
            <div id="error" class="hidden mt-8 w-full max-w-lg mx-auto bg-red-900/50 border border-red-500 text-red-300 px-4 py-3 rounded-lg" role="alert">
                <strong class="font-bold">Error:</strong>
                <span id="error-message" class="block sm:inline">Something went wrong.</span>
            </div>

            <!-- Results Display -->
            <div id="results-grid" class="grid grid-cols-1 md:grid-cols-2 gap-8 mt-10 w-full">
                <!-- Original Image -->
                <div id="original-container" class="bg-gray-800 p-4 rounded-xl shadow-lg">
                    <h2 class="text-xl font-semibold mb-4 text-gray-300">Original Image</h2>
                    <div class="aspect-square bg-gray-700 rounded-lg overflow-hidden">
                        <img id="originalImage" src="" alt="Original user upload" class="w-full h-full object-contain">
                    </div>
                    <button type="button" id="createOutlineButton" class="hidden mt-4 bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-lg transition-colors w-full text-lg">
                        Create Outline
                    </button>
                </div>
                <!-- Generated Outline -->
                <div id="outline-container" class="hidden bg-gray-800 p-4 rounded-xl shadow-lg">
                    <h2 class="text-xl font-semibold mb-4 text-gray-300">Generated Outline</h2>
                    <div class="aspect-square bg-gray-700 rounded-lg overflow-hidden">
                        <img id="outlineImage" src="" alt="AI-generated outline" class="w-full h-full object-contain">
                    </div>
                </div>
            </div>

            <button id="startOverButton" class="hidden mt-8 bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-6 rounded-lg transition-colors">
                Start Over
            </button>
        </div>
    </div>

    <script type="module">
        // Use the new, recommended @fal-ai/client
        import { fal } from 'https://esm.sh/@fal-ai/client';
        import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';

        // Get API keys from environment variables
        const FAL_API_KEY = import.meta.env.VITE_FAL_API_KEY;
        const GEMINI_API_KEY = import.meta.env.VITE_GEMINI_API_KEY;
        const SUPABASE_URL = import.meta.env.VITE_SUPABASE_URL;
        const SUPABASE_ANON_KEY = import.meta.env.VITE_SUPABASE_ANON_KEY;

        // Initialize Supabase client
        const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // DOM Element References
        const modelSelect = document.getElementById('modelSelect');
        const promptInput = document.getElementById('promptInput');
        const uploadContainer = document.getElementById('upload-container');
        const dropzone = document.getElementById('dropzone');
        const fileInput = document.getElementById('fileInput');
        const uploadButton = document.getElementById('uploadButton');
        
        const appContainer = document.getElementById('app-container');
        const loading = document.getElementById('loading');
        const loadingStatus = document.getElementById('loading-status');
        const errorContainer = document.getElementById('error');
        const errorMessage = document.getElementById('error-message');
        
        const resultsGrid = document.getElementById('results-grid');
        const originalContainer = document.getElementById('original-container');
        const outlineContainer = document.getElementById('outline-container');
        const originalImage = document.getElementById('originalImage');
        const outlineImage = document.getElementById('outlineImage');
        const createOutlineButton = document.getElementById('createOutlineButton');
        const startOverButton = document.getElementById('startOverButton');

        let isProcessing = false;
        let currentFile = null;

        // --- Event Listeners ---
        dropzone.addEventListener('click', () => fileInput.click());
        uploadButton.addEventListener('click', (e) => {
            e.stopPropagation();
            fileInput.click();
        });
        fileInput.addEventListener('change', (e) => {
            if (e.target.files && e.target.files[0]) {
                handleFile(e.target.files[0]);
            }
        });
        createOutlineButton.addEventListener('click', processImage);
        startOverButton.addEventListener('click', resetApp);

        // --- Drag and Drop ---
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropzone.addEventListener(eventName, preventDefaults, false);
            document.body.addEventListener(eventName, preventDefaults, false);
        });
        ['dragenter', 'dragover'].forEach(eventName => {
            dropzone.addEventListener(eventName, () => dropzone.classList.add('drag-active'), false);
        });
        ['dragleave', 'drop'].forEach(eventName => {
            dropzone.addEventListener(eventName, () => dropzone.classList.remove('drag-active'), false);
        });
        dropzone.addEventListener('drop', (e) => {
            if (e.dataTransfer.files && e.dataTransfer.files[0]) {
                handleFile(e.dataTransfer.files[0]);
            }
        }, false);
        
        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }
        
        function handleFile(file) {
            if (!file.type.startsWith('image/')) {
                alert('Invalid file type. Please upload an image.');
                return;
            }
            currentFile = file;

            const reader = new FileReader();
            reader.onload = (e) => {
                originalImage.src = e.target.result;
                uploadContainer.classList.add('hidden');
                appContainer.classList.remove('hidden');
                resultsGrid.classList.remove('hidden');
                outlineContainer.classList.add('hidden');
                createOutlineButton.classList.remove('hidden');
                startOverButton.classList.add('hidden');
                errorContainer.classList.add('hidden');
            };
            reader.onerror = () => alert('Could not read the selected file.');
            reader.readAsDataURL(file);
        }

        async function processImage() {
            if (isProcessing) return;

            const selectedModel = modelSelect.value;
            const prompt = promptInput.value.trim();

            if (!prompt) {
                alert('Please enter a prompt.');
                return;
            }

            // Check API key based on selected model
            if (selectedModel === 'flux-pro' && (!FAL_API_KEY || FAL_API_KEY === 'your_fal_api_key_here')) {
                alert('Flux Pro API key not configured. Please add your fal.ai API key to the .env file.');
                return;
            }

            if (selectedModel === 'gemini' && (!GEMINI_API_KEY || GEMINI_API_KEY === 'your_gemini_api_key_here')) {
                alert('Gemini API key not configured. Please add your Gemini API key to the .env file.');
                return;
            }

            isProcessing = true;
            loading.classList.remove('hidden');
            createOutlineButton.classList.add('hidden');
            errorContainer.classList.add('hidden');

            // Save prompt to database
            await savePromptToLibrary(prompt, selectedModel);

            if (selectedModel === 'flux-pro') {
                runFluxPro(currentFile, prompt);
            } else if (selectedModel === 'gemini') {
                runGemini(currentFile, prompt);
            }
        }

        /**
         * Saves a prompt to the library in Supabase
         */
        async function savePromptToLibrary(promptText, model) {
            try {
                // Check if prompt already exists
                const { data: existing } = await supabase
                    .from('prompts')
                    .select('id, used_count')
                    .eq('prompt_text', promptText)
                    .eq('model', model)
                    .maybeSingle();

                if (existing) {
                    // Update usage count
                    await supabase
                        .from('prompts')
                        .update({ used_count: existing.used_count + 1 })
                        .eq('id', existing.id);
                } else {
                    // Insert new prompt
                    await supabase
                        .from('prompts')
                        .insert({
                            prompt_text: promptText,
                            model: model,
                            used_count: 1
                        });
                }
            } catch (error) {
                console.error('Error saving prompt:', error);
            }
        }

        /**
         * Calls the Flux Pro API to generate the image outline
         */
        async function runFluxPro(imageFile, prompt) {
            loadingStatus.textContent = 'Connecting to Flux Pro API...';

            try {
                fal.config({
                    credentials: FAL_API_KEY,
                });

                const result = await fal.subscribe("fal-ai/flux-pro/v1/canny", {
                    input: {
                        prompt: prompt,
                        control_image_url: imageFile,
                    },
                    logs: true,
                    onQueueUpdate: (update) => {
                        if (update.status === "IN_PROGRESS" && update.logs.length > 0) {
                           const lastLog = update.logs[update.logs.length - 1].message;
                           loadingStatus.textContent = lastLog;
                        }
                    },
                });

                if (result && result.data && result.data.images && result.data.images.length > 0) {
                    outlineImage.src = result.data.images[0].url;
                    outlineContainer.classList.remove('hidden');
                } else {
                    throw new Error("API did not return a valid image. Check the model's output format.");
                }

            } catch (error) {
                console.error("Flux Pro API Error:", error);
                showError(error.message || 'An unknown error occurred during processing.');
            } finally {
                isProcessing = false;
                loading.classList.add('hidden');
                loadingStatus.textContent = 'Processing your image...';
                startOverButton.classList.remove('hidden');
            }
        }

        /**
         * Calls the Gemini API to generate the image outline
         */
        async function runGemini(imageFile, prompt) {
            loadingStatus.textContent = 'Connecting to Gemini API...';

            try {
                // Convert file to base64
                const base64 = await fileToBase64(imageFile);

                loadingStatus.textContent = 'Processing with Gemini...';

                // Call Gemini 2.5 Flash Image API using v1beta endpoint
                const requestBody = {
                    contents: [{
                        parts: [
                            { text: prompt },
                            {
                                inline_data: {
                                    mime_type: imageFile.type,
                                    data: base64
                                }
                            }
                        ]
                    }],
                    generation_config: {
                        response_modalities: ['IMAGE']
                    }
                };

                console.log('Sending request to Gemini:', JSON.stringify(requestBody, null, 2).substring(0, 500));

                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-image:generateContent?key=${GEMINI_API_KEY}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestBody)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    console.error('API Error Response:', errorData);
                    throw new Error(errorData.error?.message || `API request failed with status ${response.status}`);
                }

                const result = await response.json();
                console.log('API Response:', result);

                if (result.candidates && result.candidates[0]?.content?.parts) {
                    const parts = result.candidates[0].content.parts;

                    for (const part of parts) {
                        if (part.inline_data) {
                            const imageData = part.inline_data;
                            const dataUrl = `data:${imageData.mime_type};base64,${imageData.data}`;

                            outlineImage.src = dataUrl;
                            outlineContainer.classList.remove('hidden');
                            return;
                        }
                    }

                    throw new Error("Gemini API did not return an image in the response.");
                } else {
                    throw new Error("Gemini API returned unexpected response structure.");
                }

            } catch (error) {
                console.error("Gemini API Error:", error);
                showError(error.message || 'An unknown error occurred with Gemini API.');
            } finally {
                isProcessing = false;
                loading.classList.add('hidden');
                loadingStatus.textContent = 'Processing your image...';
                startOverButton.classList.remove('hidden');
            }
        }

        /**
         * Converts a file to base64 string
         */
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => {
                    const base64 = reader.result.split(',')[1];
                    resolve(base64);
                };
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }
        
        function showError(message) {
            errorMessage.textContent = message;
            errorContainer.classList.remove('hidden');
            resultsGrid.classList.add('hidden'); // Hide results on error
            startOverButton.classList.remove('hidden');
        }

        function resetApp() {
            isProcessing = false;
            currentFile = null;
            fileInput.value = ''; 
            
            appContainer.classList.add('hidden');
            uploadContainer.classList.remove('hidden');
        }
    </script>
</body>
</html>